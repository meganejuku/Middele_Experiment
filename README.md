# HSI(ハイパースペクトルイメージ)を使ったFaster R-CNNの実装

## ファイルの説明
- hsi_faster_rcnn.py
`get_model`関数で、`torchvision.models.detection.FasterRCNN`をインポートし、そのbackbornのResNet50の1層目をHSIの入力サイズに合わせている。これによって、IMAGEnet-1000クラス分類で事前学習したモデルをそのまま利用しつつ、HSIで物体検出をできるようにしている。
学習時はtrain_lossとvalid_loss,P(precision),R(recall),また、PとRを用いて計算されるF1値を1epochごとに出力する。
加えて、HSIに対して推論を行う関数`visualize`も定義されている。これを実行して、test画像に対してバウンディングボックスを表示する。
実行するには、コード中にコメントアウトされているように、ターミナルの中でtrain/predictのモードを選択し、データセットやハイパーパラメータを指示することで実行できる。

- eval_pr.py
モデルの評価を行う。p-rカーブを計算し、出力する。

- dataset
train,valid,testの各ディレクトリ内に、Annotations,TIFFImages,JPGImagesというディレクトリがある。JPGImagesはアノテーションする際に使ったデータなので、今回は使用しない。よって、AnnotationsとTIFFImagesのみを使用する。
Annotationsには、PASCAL VOC形式の、.xmlファイルでアノテーションが保存されている。
TIFFImagesには、battery_train_100_000_103_snapshot_cube.tiffなどのHSIが保存されている。

- runs
実行結果を主に保存する。
- models
学習したモデルを保存する。
- sample
今回扱うHSIのデータのサンプルが入っている。自由に編集してもらって構いません。

## データセット
今回は、ゴミの中に混ざるモバイルバッテリーを検知する取り組みを行っている。
ゴミのサンプル中のランダムな位置にモバイルバッテリーを1つだけ配置し、それを撮影することで、モバイルバッテリーの位置を検出する。
撮影枚数は、train:valid:test = 400,100,10で、HSI(ハイパースペクトルイメージ)というデータになっている。

HSIのサイズは、(H, W, ch) = (275, 290, 51)であり、uint16で保存されているので、0-65535の値を持つ。また、拡張子は.tiffで、tifffileなどの専用のライブラリで読み込むことができる。


## 要望
１．hsi_faster_rcnn.pyでは現在、学習と推論を行うような仕組みになっているが、自分としては学習と推論は別のファイルで行えるようにしたい(例えば、inference.pyなどで別に実装する、など)。

２．学習部と推論部を分離した後、各.pyファイルに変なところ・致命的なバグのあるところがないかどうかを確認してほしい。

３．モデルの評価をする際、現在はp-rカーブを出力するのみだが、mAP50-95と、mAP50、true-falseとPositive-negativeの混合行列を出力するプログラムも出力するようにしてほしい(現在は物体検出で検出するのは1クラスで、物体と背景の2クラス分類なので、2*2の混合行列で表せると思います)。

